app.controller('RecipeCtrl', ['$scope','$auth','$location','$http','$routeParams','$sce','Upload', function($scope, $auth, $location,$http,$routeParams,$sce,Upload){

  $scope.recipe = {};
  $scope.showDialog = false;
  $scope.showDialog2 = false;
  $scope.myNotes = "";
  $scope.myImage = {};
  $scope.formComplete = {};

  //CHECK IF USER IS LOGGED IN
  var userSignedIn = function() {
    $auth.validateUser().
    then(function(resp) {
      $scope.user = resp;
    }).
    catch(function(resp) {
      console.log(resp);
    });
  };

  //GET INFORMATION ON ONE RECIPE
  var getRecipeProfile = function () {
    $http({
      method: "GET",
      url: "/api/recipes/"+$routeParams.id+".json"
    }).then(function (response){
      resetTools();
      $scope.recipe = response.data;
      $scope.ingredients = $scope.recipe.ingredients;
      $scope.instructions = $scope.recipe.instructions;
      $scope.tools = $scope.recipe.equipment.split(",");
      getTools();
      $scope.video = $sce.trustAsHtml('<iframe height="100%" src="'+$scope.recipe.video_url+'" frameborder="0" allowfullscreen></iframe>');
    },function (response){
      console.log(response);
    });
  };

  //DISPLAY EQUIPMENT REQUIRED
  var getTools = function (){
    if ($scope.tools.includes("pot")) {$scope.pot = true;}
    if ($scope.tools.includes("pan")) {$scope.pan = true;}
    if ($scope.tools.includes("bowl")) {$scope.bowl = true;}
    if ($scope.tools.includes("stove")) {$scope.stove = true;}
    if ($scope.tools.includes("measuring")) {$scope.measuring = true;}
    if ($scope.tools.includes("oven")) {$scope.oven = true;}
    if ($scope.tools.includes("blender")) {$scope.blender = true;}
    if ($scope.tools.includes("rice")) {$scope.rice = true;}
  };

  //RESET EQUIPMENT BOOLEAN FOR NEW RECIPE
  var resetTools = function (){
    $scope.pot = false;
    $scope.pan = false;
    $scope.bowl = false;
    $scope.stove = false;
    $scope.measuring = false;
    $scope.oven = false;
    $scope.blender = false;
    $scope.rice = false;
  };

  //DISPLAY MODAL FOR PERSONAL TRIAL OR CHALLENGE
  $scope.checkValid = function (num) {
    $auth.validateUser().
    then(function(resp) {
      if (num==1){$scope.showDialog = !$scope.showDialog;};
      if (num==2){$scope.showDialog2 = !$scope.showDialog2;};
    }).
    catch(function(resp) {
      alert("Please login to proceed");
    });
  };

  //CREATE DATABASE ENTRY FOR PERSONAL TRIAL
  $scope.formComplete.create = function(){
    var data = {
      creator_id: $scope.user.id,
      participant_id: $scope.user.id,
      recipe_id: $scope.recipe.id,
      creator_status: "pending",
      participant_acceptance: "accepted",
      participant_status: "complete",
      post_status: "pending",
      post_type: "personal",
    };
    $http({
      method: "POST",
      url: "/api/challenges.json",
      data: data
    }).then(function (response){
      console.log(response);
      $scope.showDialog = !$scope.showDialog;
    },function (response){
      console.log(response);
    });
  };

  //GET ALL USERS FOR CHALLENGE SELECTION
  var getUsers = function () {
    $http({
      method: "GET",
      url: "/api/users.json"
    }).then(function (response){
      console.log(response.data);
      $scope.userlist = response.data;
    },function (response){
      console.log(response);
    });
  };

  //DISPLAY SELECTED CHALLENGER
  $scope.confirmChallenger = function(index) {
    $scope.selectedUser = $scope.userlist[index];
  };

  //CREATE DATABASE ENTRY FOR CHALLENGING OTHER USER
  $scope.createChallenge = function(){
    var data = {
      recipe_id: $scope.recipe.id,
      creator_id: $scope.user.id,
      participant_id: $scope.selectedUser.id,
      participant_acceptance: "pending",
      participant_status: "pending",
      creator_status: "pending",
      post_status: "pending",
      post_type: "challenge"
    };
    $http({
      method: "POST",
      url: "/api/challenges.json",
      data: data
    }).then(function (response){
      console.log(response.data);
      $scope.showDialog2 = !$scope.showDialog2;
    },function (response){
      console.log(response);
    });
  };

  getRecipeProfile();
  userSignedIn();
  getUsers();
}]);