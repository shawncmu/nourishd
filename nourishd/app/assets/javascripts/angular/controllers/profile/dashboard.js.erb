app.controller('DashCtrl', ['$scope','$auth','$location','$http','Upload','angularGridInstance','$mdDialog','$interval', function($scope, $auth, $location,$http,Upload,angularGridInstance,$mdDialog,$interval){

  $scope.loading=false;
  $scope.mychallenges = [];
  $scope.finishedImage = {};

  //CHECK IF USER IS LOGGED IN AND GET USER INFORMATION
  $auth.validateUser().
  then(function(resp) {
    $scope.user = resp;
    getUserImage();
  }).
  catch(function(resp) {
    console.log(resp);
    $location.path('/login');
  });

  //GET USER IMAGE FOR DISPLAY IN PROFILE
  var getUserImage = function (){
    $http({
      method: "GET",
      url: "/api/users/"+$scope.user.id+".json"
    }).then(function (response){
      console.log(response.data);
      $scope.avatar = response.data.avatar_image;
    },function (response){
      console.log(response);
    });
  };

  //GET ALL CHALLENGES FOR CURRENT USER
  var getAllChallenges = function () {
    $http({
      method: "GET",
      url: "/api/challenges/"+$scope.user.id+".json"
    }).then(function (response){
      $scope.mychallenges = response.data;
      getCompletedChallenges();
    },function (response){
      console.log(response);
    });
  };

  //UPLOAD COMPLETED RECIPE
  $scope.recipeDone = function(id, creator, other){
    $scope.loading=true;
    var temp = "";
    if (other == "pending"){
      temp = "pending";
    } else {
      temp = "complete";
    };
    if(creator=="me"){
      var data = {
        creator_image:$scope.finishedImage.file,
        creator_status: "complete",
        post_status: temp
      };
    } else {
      var data = {
        participant_image:$scope.finishedImage.file,
        participant_status: "complete",
        post_status: temp
      };
    };
    Upload.upload({
      url: '/api/challenges/'+id+'.json',
      method:'PUT',
      fields: data
    }).success(function(response) {
      console.log(response);
      getAllChallenges();
      $scope.showDialog3 = !$scope.showDialog3;
      $scope.loading=false;
    });
  };

  //REFRESH DISPLAY GRID
  $scope.refresh = function(){
    angularGridInstance.gallery.refresh();
  }

  //ADD 1 LIKE TO SELECTED RECIPE
  $scope.likeRecipe = function(id, winner, index){
    var data = {
      user_id: $scope.user.id,
      challenge_id: id,
      winner: winner
    }
    $http({
      method: "POST",
      url: "/api/likes.json",
      data: data
    }).then(function (response){
      console.log(response.data);
      if (winner=="creator"){
        $scope.myCompletedChallenges[index].creator_likes = $scope.myCompletedChallenges[index].creator_likes+1;
        $scope.myCompletedChallenges[index].voted_before = true;
      } else {
        $scope.myCompletedChallenges[index].participant_likes = $scope.myCompletedChallenges[index].participant_likes+1;
        $scope.myCompletedChallenges[index].voted_before = true;
      }
    },function (response){
      console.log(response);
    });
  };

  //FILTER RESULTS FOR ALL COMPLETED CHALLENGES BY CURRENT USER
  var getCompletedChallenges = function () {
    $scope.myCompletedChallenges = [];
    for (var i=0; i<$scope.mychallenges.length;i++) {
      if ($scope.mychallenges[i].post_status == "complete") {
        $scope.myCompletedChallenges.push($scope.mychallenges[i]);
      };
    };
  };

  //FILTER RESULTS FOR CHALLENGES DECLINED BY USER
  $scope.checkDeclined = function (challenge){
      if (challenge.participant_acceptance=='declined' && challenge.creator=='other') {
        return false;
      } else {
        return true;
      };
  };

  //DECLINE A CHALLENGE
  $scope.declineChallenge = function (id, index) {
    console.log(id, index);
    var data = {
      participant_acceptance: "declined",
      participant_status: "declined"
    };
    $http({
      method: "PUT",
      url: "/api/challenges/"+id+".json",
      data: data
    }).then(function (response){
      console.log(response.data);
      getAllChallenges();
    },function (response){
      console.log(response);
    });
  };

  //DELETE A CHALLENGE
  $scope.deleteChallenge = function (id, index) {
    console.log(id, index);
    $http({
      method: "DELETE",
      url: "/api/challenges/"+id+".json"
    }).then(function (response){
      console.log(response.data);
      getAllChallenges();
    },function (response){
      console.log(response);
    });
  };

  //ACCEPT A CHALLENGE
  $scope.acceptChallenge = function (id, index) {
    console.log(id, index);
    var data = {
      participant_acceptance: "accepted",
    };
    $http({
      method: "PUT",
      url: "/api/challenges/"+id+".json",
      data: data
    }).then(function (response){
      console.log(response.data);
      getAllChallenges();
    },function (response){
      console.log(response);
    });
  };

  //DISPLAY MODAL UPON CHALLENGE COMPLETION
  $scope.openComplete = function(id, person, otherPerson) {
    $auth.validateUser().
    then(function(resp) {
      $scope.showDialog3 = !$scope.showDialog3;
      $scope.holder1 = id;
      $scope.holder2 = person;
      $scope.holder3 = otherPerson;
    }).
    catch(function(resp) {
      alert("Please login to proceed");
    });
  };

getAllChallenges();
}]);